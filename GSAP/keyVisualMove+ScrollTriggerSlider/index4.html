<!DOCTYPE html>
<html lang="ko">
    <head>
        <title>KeyVisualMove + ScrollTriggerSlider</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/ScrollTrigger.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/ScrollToPlugin.min.js"></script>
    </head>
    <body>
        <div id="wrap">
            <div class="about">
                <div class="about-section slide about-section--01" style="position: relative; overflow: hidden">
                    <div id="moveBox">
                        <img src="./img/kv.png" alt="" class="" />
                    </div>
                    SECTION 1
                </div>
                <script>
                    var moveBox = $('#moveBox');

                    function mainMove(e) {
                        $(moveBox).css({
                            transition: '1.5s ease-out',
                        });
                        $(moveBox).parent().scrollTop(0);
                        $(moveBox).parent().scrollLeft(0);
                        var winWidth = window.innerWidth;
                        var winHeight = window.innerHeight;
                        var contWidth = $(moveBox).innerWidth();
                        var contHeight = $(moveBox).innerHeight();

                        // 마우스 위치를 비율로 변환
                        var ratioX = e.pageX / winWidth; // 0에서 1 범위
                        var ratioY = e.pageY / winHeight; // 0에서 1 범위

                        // 이동 거리 계산
                        var movePositionX = (winWidth - contWidth) * ratioX; // 마우스의 X 위치에 따라 이동
                        var movePositionY = (winHeight - contHeight) * ratioY; // 마우스의 Y 위치에 따라 이동

                        // GSAP를 사용하여 애니메이션을 부드럽게 처리
                        gsap.to(moveBox[0], {
                            x: movePositionX,
                            y: movePositionY,
                            duration: 0.3,
                            ease: 'power3.out',
                        });
                    }

                    function findObjCoords(e) {
                        var obj = e.currentTarget;
                        var obj_left = 0;
                        var halfSize = obj.getBoundingClientRect().width / 2;

                        while (obj.offsetParent) {
                            obj_left += obj.offsetLeft;
                            obj = obj.offsetParent;
                        }
                        var xpos = e.pageX - obj_left;

                        if (xpos < halfSize) {
                            e.currentTarget.classList.remove('mouse-right');
                            e.currentTarget.classList.add('mouse-left');
                        } else {
                            e.currentTarget.classList.remove('mouse-left');
                            e.currentTarget.classList.add('mouse-right');
                        }
                    }

                    $(document).ready(function () {
                        // 초기 위치를 중앙으로 설정
                        function centerMoveBox(transition) {
                            var winWidth = window.innerWidth;
                            var winHeight = window.innerHeight;
                            var contWidth = $(moveBox).innerWidth();
                            var contHeight = $(moveBox).innerHeight();

                            // 중앙 위치 계산
                            var centerX = (winWidth - contWidth) / 2;
                            var centerY = (winHeight - contHeight) / 2;

                            $(moveBox).css({
                                transform: `translate(${centerX}px, ${centerY}px)`,
                                transition: transition,
                            });
                        }

                        centerMoveBox('none'); // 페이지 로드 시 중앙으로 이동

                        $('.about-section--01').each(function () {
                            this.addEventListener(
                                'mousemove',
                                function (e) {
                                    mainMove(e);
                                    findObjCoords(e);
                                },
                                true
                            );
                        });

                        $(window).resize(function () {
                            centerMoveBox('1.5s ease-out');
                        });
                    });
                </script>

                <div class="about-section slide about-section--02">SECTION 2</div>
                <div class="about-section slide about-section--03">SECTION 3</div>

                <div class="about-section slide">
                    <div class="box1" style="height: 300vh; background-color: rosybrown"></div>
                </div>
                <div class="about-section">
                    <div class="box2">
                        <div class="box2__inner">
                            <div class="prdslider">
                                <ul>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                    <li><div style="width: 400px; height: 500px; background-color: gray"></div></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="about-section">
                    <div class="box3" style="height: 300vh; background-color: rosybrown"></div>
                </div>
            </div>
        </div>
        <script>
            $(function () {
                let isScrolling = false;
                const sections = gsap.utils.toArray('.about-section.slide');
                let currentSectionIndex = 0;
                let scrollPrevented = true;

                function preventScrollInSections(e) {
                    if (scrollPrevented) {
                        e.preventDefault();
                    }
                }

                function goToSection(i) {
                    if (isScrolling || i < 0 || i >= sections.length) return;

                    isScrolling = true;

                    gsap.to(window, {
                        scrollTo: { y: sections[i].offsetTop, autoKill: false },
                        duration: 1,
                        ease: 'expo.inOut',
                        onComplete: () => {
                            isScrolling = false;
                            currentSectionIndex = i;
                            console.log(`현재 섹션 인덱스: ${currentSectionIndex}`);

                            // 스크롤 방지 상태 업데이트
                            if (currentSectionIndex < sections.length - 1) {
                                scrollPrevented = true; // 마지막 섹션이 아닐 경우 스크롤 방지
                            } else {
                                console.log('마지막 섹션에서 스크롤 방지 해제');
                                scrollPrevented = false; // 마지막 섹션일 경우 스크롤 방지 해제
                                document.body.style.overflow = '';

                                // 슬라이드 클래스만 가진 ScrollTrigger 해제
                                ScrollTrigger.getAll().forEach((trigger) => {
                                    if ($(trigger.trigger).hasClass('slide')) {
                                        trigger.kill();
                                    }
                                });
                            }
                        },
                    });
                }

                function onWheelEvent(e) {
                    if (isScrolling) return;

                    const delta = e.deltaY;
                    console.log(`휠 스크롤 방향: ${delta}`);
                    if (delta > 0 && currentSectionIndex < sections.length - 1) {
                        goToSection(currentSectionIndex + 1);
                    } else if (delta < 0 && currentSectionIndex > 0) {
                        goToSection(currentSectionIndex - 1);
                    }
                }

                window.addEventListener(
                    'wheel',
                    (e) => {
                        preventScrollInSections(e);
                        onWheelEvent(e);
                    },
                    { passive: false }
                );

                currentSectionIndex = sections.findIndex((section) => {
                    return window.scrollY >= section.offsetTop && window.scrollY < section.offsetTop + section.offsetHeight;
                });

                document.body.style.overflow = 'hidden';

                gsap.utils.toArray('.about-section.slide').forEach((panel, i) => {
                    ScrollTrigger.create({
                        trigger: panel,
                        start: 'top top',
                        end: 'bottom top',
                        onEnter: () => {
                            console.log(`섹션 ${i + 1} 진입`);
                            goToSection(i);
                        },
                        onEnterBack: () => {
                            console.log(`섹션 ${i} 후진`);
                            goToSection(i - 1);
                        },
                        markers: true,
                    });
                });
            });
        </script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                overflow-y: scroll; /* 세로 스크롤 유지 */
            }
            ::-webkit-scrollbar {
                display: none; /* 스크롤바를 숨김 */
            }
            body {
                scrollbar-width: none; /* Firefox에서 스크롤바를 숨김 */
            }
            #wrap {
                overflow: hidden;
            }
            .about-section {
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 2em;
            }
            .contents {
                margin: 0;
                padding: 0;
            }
            .about-section--01 {
                position: relative;
                height: 100vh;
            }
            .about-section--02 {
                position: relative;
                height: 100vh;
            }
            .about-section--03 {
                position: relative;
                height: 100vh;
            }
            #moveBox {
                position: absolute;
                top: 0;
                left: 0;
                width: auto;
                height: auto;
                transition-timing-function: ease-out;
                transition-duration: 1.5s;
                padding: 40px;
            }
            #moveBox::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: calc(100% - 20px);
                height: calc(100% - 20px);
                border: 10px solid yellow; /* 보더 색상 및 두께 */
            }
            .box2 {
                height: 100vh;
                background-color: #000;
            }
            .box2__inner {
                position: relative;
                height: 100vh;
                padding: 120px 0;
            }
            .box2 ul {
                position: absolute;
                top: 50%;
                left: 0;
                transform: translateY(-50%);
                white-space: nowrap;
                margin: 0 -10px;
            }
            .box2 ul li {
                display: inline-block;
                padding: 0 10px;
            }
        </style>
    </body>
</html>
